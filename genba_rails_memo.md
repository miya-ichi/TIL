# 現場で使えるRuby on Rails 5速習実践ガイド
## Chapter2 Railsアプリケーションを覗いてみよう
### Railsでアプリケーションを動かす
`rails nes アプリ名`で作業ディレクトリ下にアプリケーションの雛形となるフォルダとファイルが自動生成される
- 上記コマンドだとDBにSQLite3が使用される。`-d DBソフト名`で特定のDBを使用する設定ができる

`bin/rails db:create`でデータベースを作成
- bin/railsコマンドはGemfile通りのGemを使用する環境上でrailsを実行できる

`bin/rails s`でサーバーを起動。http://localhost:3000/ にアクセスするとRailsのページが表示される
- HTTPサーバーは標準ではPumaが使われている。
### ユーザー管理機能の雛形をつくる
```
bin/rails generate scaffold user name:string address:string age:integer
bin/rails db:migrate
bin/rails s
```
上記コマンドにてユーザー管理機能の雛形を簡単に作成できる  
この雛形は作成(Create),読み出し(Read),更新(Update),削除(Delete)の機能を持っている。
- 上記4機能はまとまって扱う場合が多い。頭文字を取って*CRUD*と呼ぶ

### MVC
RailsアプリケーションはM(モデル),V(ビュー),C(コントローラ)という考え方で構成されている  
### コントローラ
クライアントからのリクエストを受け、適切なレスポンスを返すための制御を行う  
まずリクエストが来たら、routes.rbに定義されたルーティング情報から、リクエストを担当する箇所を特定する(どのコントローラのどのアクションが実行するかを決める)  
### モデル
データとデータに関連する処理を行う  
コントローラのアクションから必要に応じて呼び出される
### ビュー
ブラウザに表示される画面を出力するコード  
ERBを使って記述する  
HTMLの中にRubyのコードを埋め込むことができる
ヘルパーメソッドというビューの中で使用できる機能がある(自分で定義することもできる)  
<html>タグなどの共通のパーツはレイアウトファイルにまとめてあり、  
個別の部分のみ各アクションごとに分けられたhtml.erbファイルに記述する  

## Chapter3 タスク管理アプリケーションを作ろう
### テンプレートエンジン
HTMLを出力する際に使用する。動的な処理を記述する際に内容が直感的でわかりやすいような書き方ができる
- ERB
- Haml
- Slim
### モデルの構成要素
- モデルに対応するRubyのクラス
- モデルに対応するデータベースのテーブル
### 命名規則
データベースのテーブル名:モデルのクラス名を複数形にする  
モデルのクラス名はキャメルケース、テーブル名はスネークケース
### ジェネレータ
モデルやコントローラ、マイグレーションなどを作成する機能  
rails g(generate)の後に作成したい種類(controllerやmodel)を指定し、その後ろに必要な情報を付けて実行する
### コントローラの作成
ジェネレータで作成できる。  
アクションもセットで作成すると効率が良い(同名のビューも作成してくれる)  
CRUD機能のアクションはパターン化されている(RESTfulの考え方に沿っている)
### link_toメソッド 
ヘルパーメソッドのひとつであり、  
`link_to 'キャプション', リンク先のURL, class: '属性の指定'`とすると、  
`<a href="リンク先のURL" class="属性">キャプション</a>`の形のHTMLを出力する。  
URLは直接文字列を指定もできるが、*URLヘルパーメソッド(new_task_pathなど)*を使用することでURLの変化に柔軟に対応するリンクが作成できる
### コントローラのアクションの基本的な役割
- アクションからビューに受け渡しをしたいデータをインスタンス変数に入れる
- ブラウザに返す画面をどうするのかを記述する
  - この記述を省略した場合、`app/views/コントローラ名/アクション名.html.slim`のビューを自動的に表示する
### Strong Parameters
受け取ったデータが不正なデータではないか確認した上で、必要なデータを取得する仕組み。
- Railsは受け取ったパラメータを直接モデルに渡すと例外を出して警告してくれる

使い方としては、コントローラの中にprivateメソッドとして定義する。  
```ruby
例
private

def task_params
  params.require(:task).permit(:name, :description)
end
```
このtask_paramメソッドをモデルのインスタンスの作成の際に実行するようにする

### Flashメッセージ
リダイレクトするときに次のリクエストに対してデータを伝える仕組み  
- ハッシュの形でデータを渡すことができる。  

`redirect_to tasks_url, notice: "◯◯"`のnotice:オプションがそれ。  
- redirect_toメソッドからは他にalert:オプションでも渡すことができる

Flashは次のリクエストに対してデータを伝える仕組みだが、flash.nowを使うことで同じリクエスト（次にレンダーするビュー）に対してデータを伝えることもできる
### パーシャル
複数のビューの内容に共通する部分がある場合、その共通する部分を抜き出して一つのコードにし、それを呼び出すことで内容の重複をなくすことができる。  
- 呼び出すコードはパーシャルテンプレートと呼ばれる。テンプレートファイルは名前の先頭に_をつける
- renderメソッドで呼び出す。呼び出す際はファイルの先頭の_は付けない

```
例(同じフォルダに_form.html.slimというパーシャルがある場合)
= render partial: 'form', locals: { task: @task }
```
- `partial: 'form'`で_form.html.slimを読み込む  
- `locals: { task: @task }`でパーシャル内のローカル変数taskに対してインスタンス変数@taskを渡す  
  
partial:とlocals:の文字は省略することもできる（どちらか一方だけ省略はできない）
```
上の例を省略形で書くと
= render 'form', task: @task
```

## Chapter4
### マイグレーション
データベースのテーブルの追加・削除などの操作をRailsを介して行うことができる機能  
Rubyのコードで書かれたマイグレーションファイルに操作を記述する  
マイグレーションファイルはデータベースに対する操作を行うたび作成するため、  
それがデータベースの変更履歴となり、チーム開発の場合メンバーが確認しやすくなる  
マイグレーションの適用＝データベースのバージョンが1つ上がる
- db:migrate : 最新までマイグレーションを適用する
- db:migrate VERSION=○◯ : 特定のバージョンまでマイグレーションが適用された状態にする
- db:rollback : バージョンを1つ戻す
- db:rollback STEP=◯ : バージョンを指定した数戻す
- db:migrate:redo : バージョンを1つ戻してから1つ上げる

マイグレーションの適用中に、コードの不備などでエラーとなり途中で終了した場合は、  
エラーの出たマイグレーションの前までが適用された状態となり、その後の分は適用されない  

マイグレーションはバージョンの上げ下げ両方を意識する  
- カラムのデータ型の変更やオプションの変更はバージョンを下げる処理を自動的にできない
マイグレーションの名前はアプリ内で一意である必要がある  
### 検証(バリデーション)
データベースに不正な値が記録されないように、ユーザーから入力された値が正しいものかを確かめること  
モデルでチェックを行うのが一般的。Railsではその仕組みが用意されている  
自分で検証用のコードを書くこともできるし、既存の検証用のヘルパーを使用することもできる  
データ不正を防ぐためには、モデルの検証＋データベースでのデータの制限の両方を行うことがおすすめ

検証でエラーになった場合は`errors.full_messages`でエラー内容を確認できる  
### 自分で検証コードを用意する
1. 検証用のメソッドをモデルクラスに登録
  - validate :検証用のメソッド名
2. 検証用のメソッドを実装
  - privateメソッドとして実装する
  - 検証結果がエラー条件に該当する場合に、errorsに対して、エラー内容を格納する処理を行う
### コールバック
モデルの登録・削除などの重要なイベントの前後に任意の処理を挟むことができる仕組み。
- モデル作成直後(after_initialize)
- 検証前後(before_validation, after_validation)
- データベースへの登録前後(before_save, before_create, after_save, after_create)
- 他、データベースの検索後、編集保存前後、削除前後などに処理を挟むことができる

不正な値がデータベースに登録されようとした時に、正規の値に修正するなどの使い方がある  
例　名前が入力必須だが空欄だった場合に「名前なし」と登録されるようにする
### トランザクション
複数の処理によるデータベースの整合性を保つための機能  
連続した処理が途中で例外などで終了した場合に、その処理をすべて取り消すことで、データの整合性を保つ  
### パスワードダイジェスト
ユーザー登録する際に、パスワードをそのままデータベースに保存すると、不正アクセスなどでパスワードが漏洩してしまう。  
そのためパスワードそのものではなく、パスワードをハッシュ化した文字列（パスワードダイジェスト）を保存する  
- `has_secure_password`を使用することで簡単に実現できる
- 使用するためにはハッシュ関数を提供するGem(bcrypt)が必要
### フィルタ
コントローラのアクションを処理する前後に任意の処理を挟む機能  
ログイン時のみ特定のアクションが実行できるように制御するなどの用途に使える  
メソッドを作成し、それをフィルタとして登録する  
- before_action(アクションの実行前に処理を行う)
### 関連の定義
モデルクラス同士を紐づけること  
この定義をしておくと、お互いに紐づいているデータをメソッドで簡単に操作することができる  
- メソッドの使用が必要ない場合は、絶対に紐付けが必要なわけではない
- has_many(紐づくモデルのデータが複数ある場合)
- belongs_to(一つのモデルに対して従属する場合)
## Chapter5 テストをはじめよう
### テストを自動化するメリット
- アプリケーションをリリースした後で機能の追加等を行う際に、新機能以外に既存機能が想定通りに動くかを確認する必要があるが、毎回各機能を手動でテストするのは、アプリケーションの規模が大きくなるほどコストも増大していく。自動化することでそのコストを削減することができる
- 上記のように機能追加等の際のテストのコストが下がることで、早いスピードで機能追加・変更を行うことができるようになる

### テストに利用するライブラリ
- RSpec
  - RubyにおけるBDDのためのテスティングフレームワーク
  - 動く仕様書(Spec)として自動テストを書くという発想で作られている
  - 要求仕様をドキュメントに記述するような感覚でテストケースを記述できる
- Capybara
  - WebアプリケーションのE2Eテスト用フレームワーク
  - RSpecと組み合わせて使う
  - Webアプリケーションのブラウザ操作をシミュレーションできる
- FactoryBot
  - テスト用のデータ作成をサポートするライブラリ

### テストの種類
- システムテスト(System Spec)
- 結合テスト(Request Spec)
- 機能テスト(Controller Spec)
- 個々の部品のテスト
  - モデル・ビュー・ルーティング・ヘルパー・メーラー・ジョブ

### RSpecによるSpecの書き方
難しいので別で勉強します。。。

## Chapter6 Railsの全体像を理解する
### ルーティング
どのようなURLへどのようなHTTPメソッドでアクセスされたら、どのコントローラのどのアクションを呼び出したいかをconfig/routes.rbに定義する。このように、アクセスを受けて適切なアクションへと案内する仕組みをルーティングと呼ぶ

### RESTfulについて
REST(REpresentational State Transfer)という設計原則に従うシステムのことを指す。  
1. HTTPリクエストはそのリクエストで必要な情報を全て持ち、前のリクエストからの状態が保存されている必要がない(ステートレス)
2. 個々の情報(リソース)への「操作」の表現がHTTPメソッドとして統一されている
3. 個々の情報(リソース)がそれぞれ一意なURIで表されている
4. ある情報(リソース)から別の情報を参照したい時は、リンクを利用する

RESTfulなシステムを開発するためのRailsの特徴
- URLが表す情報のことをリソースと呼ぶ
- 一般的なブラウザのサポートするGET/POST以外にPATCH/PUT/DELETEなどのHTTPメソッドをサポートする
- 操作はHTTPメソッドで行うものとし、URLで表現しないようにする。そのためURLは名詞にする

### Strong Parameters
ユーザーからのリクエストに含まれるパラメータがアプリ側で想定した値になっているかをチェックする機能  
悪意のあるユーザーから不正なパラメータを送られても、受け付けないようにする。  
上段にも同じようなことメモってた。

### アセットパイプライン
JavaScript,CSS,画像などのアセットを効率的に読み込めるように、コンパイル・連結・圧縮などする機能。  
sprockets-railsというGemがやっている
https://railsguides.jp/asset_pipeline.html

どうでもいいけどここのChapter眠たかった・・・

## Chapter7 機能を追加してみよう
### 新規登録を行う際に確認画面を表示する
コントローラとモデル・ビューのコードでの関連がよくわからなくなった。
- 要復習
### 検索機能を追加
タスクの検索機能を追加する。  
- RansackというGemを利用する。
### メール送信機能を追加
- mailerを実装
- テンプレートの実装

実際に動作しているかの確認にMailCatcherというGemを利用する
- 最初はインストール失敗してしまった
  - https://github.com/sj26/mailcatcher
  - `gem install thin -v 1.5.1 -- --with-cflags="-Wno-error=implicit-function-declaration"`
  - 上記コマンド実行後に再インストールでうまくいった

### ファイルのアップロード
Active Storageを利用する（標準でRailsに添付）  
- `config/environments/development.rb`

および
- `config/storage.yml`の中にファイルの実体の管理場所の設定を記述

開発環境と運用環境で分けて設定できる
- 開発環境ではローカルが初期値

### CSV形式で入出力

### ページネーションの実装
kaminariというGemをつかう

### 非同期処理
Active Jobという名前のフレームワークがある
